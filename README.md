Apache Kafka 버전 3.6.0 사용

producer 멱등성
- 멱등성 : 동일한 작업을 여러번 수행해도 결과가 동일하게 유지되는 특성
- 같은 데이터를 여러 번 전송하더라도 해당 데이터가 카프카 클러스터에 단 한 번만 저장되도록 보장


멱등성 보장에 필요한 속성
1. ACKS_CONFIG 
프로듀서가 브로커에게 메시지를 보낸 후 받는 응답의 수준 
- acks=0: 프로듀서가 브로커에게 메시지를 보내고, 응답 기다리지 않음. 메시지 손실 가능성 높음
- acks=1: 리더 파티션에 저장되었는지 확인함. 메시지가 최소 한 곳의 브로커에 저장되었음을 보장. 전송 속도와 신뢰성 밸런스
- acks=all 또는 acks=-1: 설정한 파티션의 수 만큼 저장 되었는지 확인함. 데이터 신뢰성을 최대화하지만, 전송 속도가 느려질 수 있음. (kafka 3.0부터 기본값)

2. enable.idempotence 
프로듀서가 레코드 쓰기 작업을 단 한 번만 허용할 것인지를 결정. 'true'로 설정해야 멱등성을 보장한다.
각 프로듀서에는 고유한 프로듀서 ID(PID)가 할당됨.
프로듀서는 메시지를 브로커에게 보낼 때마다 이 PID를 포함하며, 각 메시지는 순차적으로 증가하는 시퀀스 번호를 받음
프로듀서가 메시지를 보내는 각 토픽 파티션마다 별도의 시퀀스가 유지되고, 브로커는 파티션별로 성공적으로 처리된 PID-시퀀스 번호 조합 중 가장 큰 값을 추적.
브로커는 프로듀서의 요청이 마지막으로 커밋된 메시지보다 시퀀스번호가 1만큼 크지 않은 경우 거부한다. 

3. max.in.flight.requests.per.connection
한 번에 몇 개의 요청을 전송할 것인지


4. retries




2. consumer 장애
1) 메세지 중복 처리
- 오프셋 오토커밋을 false로 하고 메세지가 처리 완료되면 커밋(동기로 하여 커밋이 완료되었는지 확인함)
2) 메세지 처리 실패
- 주문 완료의 경우 처리가 실패 되면 접수 실패로 리턴
- 그 외 기능은 실패 시 해당 오프셋으로 다시 처리(?) <- 잘못하면 무한반복 될 수 도 있음

3. consumer group 테스트
1) offset이 있는 경우: 서비스가 재기동 되었을 때
- auto.offset.reset 설정 적용 안함
- 쌓여있는 offset 순차적으로 처리함
2) offset이 없는 경우: consumer group이 새로 만들어 졌을 때
- auto.offset.reset 설정 적용됨
- earliest: 처음 offset 부터 구독
- latest: 마지막 offset 다음 부터 구독
