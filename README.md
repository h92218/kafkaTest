Apache Kafka 버전 3.6.0 사용

producer 멱등성
- 멱등성 : 동일한 작업을 여러번 수행해도 결과가 동일하게 유지되는 특성
- 같은 데이터를 여러 번 전송하더라도 해당 데이터가 카프카 클러스터에 단 한 번만 저장되도록 보장


멱등성 보장에 필요한 속성
- max.in.flight.requests.per.connection <= 5
- retries > 0
- acks = all(-1)
  
1. ACKS_CONFIG 
프로듀서가 브로커에게 메시지를 보낸 후 받는 응답의 수준 
- acks=0: 프로듀서가 브로커에게 메시지를 보내고, 응답 기다리지 않음. 메시지 손실 가능성 높음
- acks=1: 리더 파티션에 저장되었는지 확인함. 메시지가 최소 한 곳의 브로커에 저장되었음을 보장. 전송 속도와 신뢰성 밸런스
- acks=all 또는 acks=-1: 설정한 파티션의 수 만큼 저장 되었는지 확인함. 데이터 신뢰성을 최대화하지만, 전송 속도가 느려질 수 있음. (kafka 3.0부터 기본값)

2. enable.idempotence (kafka 3.0 부터 기본값 true)
프로듀서가 레코드 쓰기 작업을 단 한 번만 허용할 것인지를 결정. 'true'로 설정해야 멱등성을 보장한다.
각 프로듀서에는 고유한 프로듀서 ID(PID)가 할당됨.
프로듀서는 메시지를 브로커에게 보낼 때마다 이 PID를 포함하며, 각 메시지는 순차적으로 증가하는 시퀀스 번호를 받음
프로듀서가 메시지를 보내는 각 토픽 파티션마다 별도의 시퀀스가 유지되고, 브로커는 파티션별로 성공적으로 처리된 PID-시퀀스 번호 조합 중 가장 큰 값을 추적.
브로커는 프로듀서의 요청이 마지막으로 커밋된 메시지보다 시퀀스번호가 1만큼 크지 않은 경우 거부한다. 

3. max.in.flight.requests.per.connection (기본값 5)
단일 브로커에 한 번에 몇 개의 요청을 전송할 것인지
값이 5 이하일 때, 프로듀서는 한 메시지가 실패하면 그 후의 메시지들은 서버에 전송되지 않는다.
예를 들어 1로 설정하였을 경우, 프로듀서가 하나의 요청을 보내고 그에 대한 응답을 받기 전에 다른 요청을 보내지 않아 메시지 전송의 일관성은 보장되지만 처리량은 낮아질 수 있음.
이러한 동작은 메시지의 순서가 변경되지 않도록 보장하는데에 중요함.
만약 이 값이 5보다 크다면, 프로듀서는 재시도하는 동안 다른 메시지들을 전송할 수 있어, 메시지 순서가 뒤바뀔 위험이 있음. 처리량이 증가하지만, 중복 전송이 발생할 수 있음.
또한 메모리와 대역폭이 더 많이 필요하고 프로듀서, Kafka 간의 네트워크 지연 및 장애로 인해 실패 가능성 증가.   
멱등성 옵션을 사용하기 위해서는 5 이하로 설정해야함. 5가 넘을 시 ConfigException이 발생함.

5. retries
메시지 전송 재시도 횟수. 0 이상으로 설정

-------
consumer offset과 autocommit 







3. consumer group 테스트
1) offset이 있는 경우: 서비스가 재기동 되었을 때
- auto.offset.reset 설정 적용 안함
- 쌓여있는 offset 순차적으로 처리함
2) offset이 없는 경우: consumer group이 새로 만들어 졌을 때
- auto.offset.reset 설정 적용됨
- earliest: 처음 offset 부터 구독
- latest: 마지막 offset 다음 부터 구독
